# Bot-Driven Login/Register Protection

This document outlines the security measures implemented to protect the authentication flow using **Google reCAPTCHA***.

---

## 1. Google reCAPTCHA Integration

We used reCAPTCHA v2 to distinguish between human users and automated bots. This prevents bot-driven account creation and automated credential-stuffing attacks. The code needed to implement this can be found in the following files:
`src/app/actions/auth.ts` 
`src/app/api/captcha/route.ts` 
`src/lib/validations/auth.ts`
`src/components/auth/register-form.tsx`
`src/components/auth/login-form.tsx`

### How it Works
The implementation follows a "Verify on the Server" pattern to ensure the token cannot be bypassed by client-side manipulation:

1.  **Token Generation (Client):** When a user interacts with the Auth form, a unique `captchaToken` is generated by the Google reCAPTCHA client library.
2.  **Payload Submission:** This token is appended to the `FormData` or login object and sent to our `use server` action.
3.  **Server-Side Verification:** Before calling any Supabase Auth methods, we verify the token with Google's API:
    ```typescript
    const response = await fetch(
      `https://www.google.com/recaptcha/api/siteverify?secret=${process.env.RECAPTCHA_SECRET_KEY}&response=${token}`,
      { method: "POST" }
    );
    ```
4.  **Enforcement:** If Google returns `success: false`, the process is aborted immediately, and no database or Auth calls are made.

### Progressive CAPTCHA (Login Flow)
Unlike registration (where CAPTCHA is always required), the login flow uses **Progressive CAPTCHA**:
* The first few login attempts are frictionless for the user.
* After **3 failed attempts**, the system sets a flag `requiresCaptcha: true`.
* Subsequent attempts **must** include a valid CAPTCHA token, or the request is rejected before password verification even occurs.

---

## 2. Custom Database Protections (RPC)

Because the standard `profiles` table is protected by **Row Level Security (RLS)**, we use **Security Definer** functions to manage security metadata:

* **`increment_failed_attempts`:** A PostgreSQL function that allows the server to increment a user's failure count without exposing the table to public `UPDATE` permissions.
* **`reset_failed_attempts`:** Clears the counter only upon a successful, verified login.
